var _ = require('underscore');
var fs = require('fs');
var assert = require('assert');
var util = require('util');
var Carmen = require('..');
var carmen = new Carmen({ bench: { source: new Speedtest() } });

var data = [
    {
        id:146,
        text:"New Zealand",
        zxy: ["8/1/106","8/2/92","8/2/93","8/5/121","8/6/121","8/245/85","8/246/85","8/246/86","8/246/88","8/246/90","8/246/91","8/246/92","8/247/89","8/247/90","8/247/91","8/247/92","8/247/93","8/248/83","8/248/84","8/248/90","8/248/91","8/248/92","8/248/93","8/249/90","8/249/91","8/249/92","8/249/93","8/249/94","8/249/95","8/250/92","8/250/93","8/250/94","8/250/95","8/250/96","8/250/101","8/251/93","8/251/94","8/251/95","8/251/96","8/251/97","8/251/99","8/251/100","8/251/101","8/252/95","8/252/96","8/252/97","8/252/98","8/252/99","8/252/100","8/252/101","8/253/95","8/253/96","8/253/97","8/253/98","8/253/99","8/253/100","8/254/97","8/254/98","8/254/99","8/255/87"],
    },
    {
        id:60,
        text:"New Caledonia",
        zxy:["8/241/113","8/241/114","8/244/112","8/244/113","8/245/112","8/245/113","8/246/111","8/246/112","8/246/113","8/247/111","8/247/112"]
    },
    {
        id:93,
        text:"Papua New Guinea",
        zxy:["8/228/121","8/228/122","8/228/123","8/228/124","8/228/125","8/228/126","8/229/121","8/229/122","8/229/123","8/229/124","8/229/125","8/229/126","8/230/121","8/230/122","8/230/123","8/230/124","8/230/125","8/231/122","8/231/123","8/231/124","8/231/125","8/232/120","8/232/121","8/232/122","8/232/123","8/232/124","8/232/126","8/233/120","8/233/121","8/233/122","8/233/123","8/233/124","8/233/126","8/234/120","8/234/121","8/234/123","8/234/124","8/234/126","8/234/127","8/235/120","8/235/121","8/235/123","8/235/124","8/235/125","8/235/126","8/236/119","8/236/120","8/236/121","8/236/124","8/236/125","8/236/126","8/237/119","8/237/124","8/237/125","8/238/123","8/238/124","8/238/125"]
    }
];
var features = [
    {
        "bounds":"-177.956962444279,-52.5773064168166,178.844049520022,-8.54335337282838",
        "lat":-43.5920925904423,
        "lon":171.229237082587,
        "name":"New Zealand",
        "population":4213418,
        "search":"New Zealand"
    },
    {
        "bounds":"159.926341186698,-22.6708114624213,168.144392538275,-19.1092717484202",
        "lat":-21.2394259641498,
        "lon":165.246517179349,
        "name":"New Caledonia",
        "population":227436,
        "search":"New Caledonia"
    },
    {
        "bounds":"140.849211059769,-11.6363945518958,155.967874797081,-1.34653167701133",
        "lat":-6.64566558834002,
        "lon":144.361803539861,
        "name":"Papua New Guinea",
        "population":6057263,"search":
        "Papua New Guinea"
    }
];
var grid = {"grid":["                                                                ","                                                                ","                                                                ","                                                                ","                                                                ","                                                                ","                                                                ","                                                                ","                                                                ","                                                                ","                                                              !!","                                                             !!!","                                                            !!!!","                                                           !!!!!","                                                          !!!!!!","                                                         !!!!!!!","                                                        !!!!!!!!","                                                      !!!!!!!!!!","                                                     !!!!!!!!!!!","                                                    !!!!!!!!!!!!","                                                   !!!!!!!!!!!!!","                                                   !!!!!!!!!!!!!","                                                   !!!!!!!!!!!!!","                                                   !!!!!!!!!!!!!","                                                   !!!!!!!!!!!!!","                                                   !!!!!!!!!!!!!","                                                   !!!!!!!!!!!!!","                                            !    !!!!!!!!!!!!!!!","                                              !!!!!!!!!!!!!!!!!!","                                              !!!!!!!!!!!!!!!!!!","                                              !!!!!!!!!!!!!!!!!!","                                             !!!!!!!!!!!!!!!!!!!","                                          !!!!!!!!!!!!!!!!!!!!!!"," !!!!                                !!  !!!!!!!!!!!!!!!!!!!!!!!","!!!!!                              !!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!                             !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!                             !!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!                    !!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!         !   !     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!     !!  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"],"keys":["146",""],"data":{"146":{"bounds":"-177.956962444279,-52.5773064168166,178.844049520022,-8.54335337282838","lat":-43.5920925904423,"lon":171.229237082587,"name":"New Zealand","population":4213418,"search":"New Zealand"}}};

function Speedtest() {};
Speedtest.prototype.open = true;
Speedtest.prototype.getInfo = function(callback) {
    return callback(null, { maxzoom:8 });
};
Speedtest.prototype.search = function(query, id, callback) {
    process.nextTick(function() {
        if (query) return callback(null, JSON.parse(JSON.stringify(data)));
        if (id) return callback(null, JSON.parse(JSON.stringify(data[0])));
    });
};
Speedtest.prototype.getGrid = function(z,x,y,callback) {
    process.nextTick(function() {
        return callback(null, JSON.parse(JSON.stringify(grid)), {});
    });
};
Speedtest.prototype.feature = function(id, callback) {
    process.nextTick(function() {
        switch (id) {
        case '146':
            return callback(null, _(features[0]).clone());
            break;
        case '60':
            return callback(null, _(features[1]).clone());
            break;
        case '93':
            return callback(null, _(features[2]).clone());
            break;
        }
    });
};

describe('benchmark', function() {
    it('x1000 forward', function(done) {
        var remaining = 1000;
        for (var i = 0, l = remaining; i < l; i++) carmen.geocode('new', function(err, res) {
            if (!--remaining) {
                assert.ifError(err);
                assert.equal(res.results[0][0].id, 'bench.60');
                done();
            }
        });
    });
});
